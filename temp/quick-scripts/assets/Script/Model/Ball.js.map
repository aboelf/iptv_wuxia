{"version":3,"sources":["Ball.js"],"names":["cc","Class","extends","Component","properties","type","get","node","name","x","y","row","set","num","column","filterBalls","balls","fiballs","filter","v","roundBalls","ball","Math","abs","alreadyConnected","lineController","connectedBalls","includes","indexOf","length","touchRelease","eventTouch","zIndex","canConnectballs","forEach","plateController","deleteBalls","generateNewBalls","countBallsFallingDistance","updateBall","clearLines","blockArea","active","dot","parent","setListener","on","Node","EventType","TOUCH_START","ballArea","children","instantiate","dotPrefab","setPosition","getPosition","TOUCH_MOVE","convertToNodeSpaceAR","touch","_point","TOUCH_END","TOUCH_CANCEL","onCollisionEnter","other","self","push","drawLine","pop","clearLastLine","actionDone","getComponent","BlockInputEvents","enabled","console","log","actionBefore","fallDown","_distance","fallAction","moveBy","ANITIME","DOWN","Action","sequence","callFunc","runAction","onLoad","start"],"mappings":"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","file":"Ball.js","sourceRoot":"../../../../../assets/Script/Model","sourcesContent":["import {\n    ANITIME,randomRange,randomRangeInt\n} from '../Config/Config';\ncc.Class({\n    extends: cc.Component,\n\n    properties: {\n        type: {\n            get() {\n                return this.node.name;\n            }\n        },\n        x: {\n            get() {\n                return this.node.x;\n            }\n        },\n        y: {\n            get() {\n                return this.node.y;\n            }\n        },\n        row: {\n            get() {\n                return this.node.row;\n            },\n            set(num) {\n                this.node.row = num;\n            }\n        },\n        column: {\n            get() {\n                return this.node.column;\n            },\n            set(num) {\n                this.node.column = num;\n            }\n        },\n    },\n    filterBalls(balls, type) { //筛选球\n        // let returnBalls = [];\n        // for (let i = 0; i < balls.length; i++) {\n        //     let fiballs = balls.filter(function (v) {\n        //         return v.name == type\n        //     });\n        //     fiballs.forEach(element => {\n        //         returnBalls.push(element);\n        //     });\n        // }\n        // return returnBalls;\n        let fiballs = balls.filter(function (v) {\n            return v.name == type\n        });\n        return fiballs;\n    },\n    roundBalls(ball) { //返回周围球(ball传入最后入队列的球)\n        if(ball.column==this.column){\n            if(Math.abs(ball.row-this.row)==1){\n                return true;\n            }else{\n                return false\n            }\n        }else{\n            if(ball.column%2==0){\n                if(Math.abs(this.column-ball.column)==1){\n                    if(this.row==ball.row || this.row==ball.row-1){\n                        return true;\n                    }else{\n                        return false;\n                    }\n                }else{\n                    return false;\n                }\n            }else{\n                if(Math.abs(this.column-ball.column)==1){\n                    if(this.row==ball.row || this.row==ball.row+1){\n                        return true;\n                    }else{\n                        return false;\n                    }\n                }else{\n                    return false;\n                }\n            }\n        }       \n    },\n    \n    alreadyConnected(ball) { //验证球是否已经在队列里\n        if (this.lineController.connectedBalls.includes(ball)) {\n            if(this.lineController.connectedBalls.indexOf(ball)==this.lineController.connectedBalls.length-2)\n                return true;\n            else{\n                return 'nothing';\n            }\n        } else {\n            return false;\n        }\n    },\n    // LIFE-CYCLE CALLBACKS:\n    touchRelease(eventTouch) {\n        //无论是否消除先将zIndex为2的珠子改为0\n        this.node.zIndex=0;\n        this.canConnectballs.forEach(function (v) {\n            v.zIndex = 0;\n        })\n        //检测是否可消除\n        if(this.lineController.connectedBalls.length>=3){\n            this.plateController.deleteBalls(this.lineController.connectedBalls);\n            this.plateController.generateNewBalls();\n            this.plateController.countBallsFallingDistance();\n            this.plateController.updateBall();\n            this.lineController.clearLines();\n            // if(this.lineController.connectedBalls.length>=5){\n                //播放莲花动画，炸=>删除珠子=>生成新珠子=>计算掉落距离=>执行掉落\n                // this.plateController.blockArea.active = false;\n                // this.plateController.deleteBalls(this.plateController.getRoundBalls(this.plateController.ballArea.children[randomRangeInt(0,39)]))\n                // this.plateController.generateNewBalls();\n                // this.plateController.countBallsFallingDistance();\n                // this.plateController.updateBall();\n            // }\n        }else{\n            this.lineController.clearLines();\n            this.plateController.blockArea.active=false;\n        }\n        this.dot.parent = null;\n        this.lineController.connectedBalls = [];\n    },\n    \n    setListener() {\n        this.node.on(cc.Node.EventType.TOUCH_START, function (eventTouch) {\n            this.plateController.blockArea.active = true; //激活遮罩\n            this.node.zIndex = 2; //设置选中珠子盖在遮罩上\n            this.canConnectballs = this.filterBalls(this.plateController.ballArea.children, this.node.name);\n            this.canConnectballs.forEach(v => {\n                v.zIndex = 2;\n            }) //设置所有同颜色珠子盖在遮罩上\n            if(!this.dot)\n                this.dot = cc.instantiate(this.plateController.dotPrefab); //创建触摸点\n            this.dot.parent = this.lineController.node; //触摸点添加到LineArea\n            this.dot.setPosition(this.node.getPosition()); //设置触摸点位置为圆心\n        }, this);\n        this.node.on(cc.Node.EventType.TOUCH_MOVE, function (eventTouch) {\n            this.dot.setPosition(this.node.parent.convertToNodeSpaceAR(eventTouch.touch._point));\n        }, this);\n\n        this.node.on(cc.Node.EventType.TOUCH_END, this.touchRelease, this);\n        this.node.on(cc.Node.EventType.TOUCH_CANCEL, this.touchRelease, this);\n    },\n    onCollisionEnter: function (other, self) {\n        if (this.lineController.connectedBalls.length == 0) {\n            this.lineController.connectedBalls.push(self.node);\n        } else {\n            if (self.node.zIndex == 2) { //判断高亮\n                if (this.roundBalls(this.lineController.connectedBalls[this.lineController.connectedBalls.length - 1])) { //判断附近球\n                    switch(this.alreadyConnected(self.node)){\n                        case false://添加到队列里\n                            this.lineController.connectedBalls.push(self.node);\n                            this.lineController.drawLine();\n                            break;\n                        case true://从队列里删除\n                            this.lineController.connectedBalls.pop(self.node);\n                            this.lineController.clearLastLine();\n                            break;\n                        case 'nothing'://什么都不做\n                            break;\n                    }\n                }\n            }\n        }\n    },\n    actionDone(){\n        this.plateController.blockArea.active = false;\n        this.plateController.blockArea.getComponent(cc.BlockInputEvents).enabled=false;\n        console.log('actionDone')\n    },\n    actionBefore(){\n        this.plateController.blockArea.getComponent(cc.BlockInputEvents).enabled=true;\n    },\n    fallDown(_distance){\n        let fallAction = cc.moveBy(ANITIME.DOWN*_distance,0,-188*_distance);\n        let Action = cc.sequence(cc.callFunc(this.actionBefore,this),fallAction,cc.callFunc(this.actionDone,this));\n        this.node.runAction(Action);\n        this.node.row=this.node.row-_distance;\n    },\n    onLoad() {\n        this.setListener();\n        this.plateController = this.node.parent.parent.getComponent(\"PlateController\");\n        this.lineController = this.node.parent.parent.children[1].getComponent(\"LineController\");\n        \n    },\n\n    start() {\n\n    },\n\n    // update (dt) {},\n});"]}